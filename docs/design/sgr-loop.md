# SGR loop

## Цель
`SgrAgent` управляет диалогом как пошаговым циклом, где LLM обязана возвращать только JSON-ответы двух типов:
- `tool_call` — выполнить инструмент;
- `final` — отдать финальный ответ пользователю.

## Контракт LLM
- Вход: `system prompt` + история + текущий `user`.
- Выход: JSON без обёртки.
- При невалидном JSON агент отправляет в LLM запрос на повтор в строгом формате.

## Инструменты
- MCP: `vkusvill_products_search`, `vkusvill_product_details`, `vkusvill_cart_link_create`.
- Local DB: `local_products_search`, `local_product_details`, `local_nutrition_query`.
- Local semantic: `local_semantic_search` через `ProductRetriever`.

## Выполнение шага
1. LLM отвечает `tool_call`.
2. Агент выполняет инструмент и готовит компактный результат (без лишних полей).
3. Результат возвращается в контекст как `TOOL_RESULT ...`.
4. Цикл продолжается до `final` или достижения `max_steps`.

## Финализация
- `final.answer` отправляется пользователю.
- Если переданы `cart_items`, но нет `cart_link`, агент создаёт ссылку корзины автоматически.
- `follow_up` добавляется в конец ответа как уточнение.

## Ограничения
- Любой выход вне JSON считается ошибкой протокола.
- Нераспознанный инструмент даёт `unknown_tool`.
- Ошибки MCP оборачиваются в диагностику, но не должны ронять процесс целиком.
